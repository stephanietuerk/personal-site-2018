<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
  	<title>Flip the District</title> 
  	<style>
	  	.active-drag {
	  		stroke: white;
	  		stroke-width: 1.5px;
	  		/*opacity: .5;*/
	  		/*stroke-dasharray: 2, 2;*/
	  		stroke-linecap: butt;
	  	}
	  	.active-drag-others {
	  		opacity: .3;
	  	}
	  	.active-mouseover {
	  		stroke: white;
	  		stroke-width: 2px;
	  		opacity: .5;
	  		/*stroke-dasharray: 2, 2;*/
	  		stroke-linecap: butt;
	  	}
	  	.bar-square {

		}
		.bars-line {
		}
		.cd-boundaries {

		}
		.cd-boundaries-drag {

		}
		.congbar-square {
			opacity: .8;
		}
		.display-data-dem {
			/*font: bold 48px monospace;*/
			font: bold 48px "Helvetica Neue";
			fill: "#2437ff";
			stroke: "none";
			/*color: "#2437ff";*/
		}
		.display-data-rep {
			font: bold 48px "Helvetica Neue";
			fill: "#f4003d";
		}
		.display-districts {
			
		}
		.display-label {
			font: 10px "Helvetica Neue";
		}
		.display-static {
			/*font: 36px "Helvetica Neue";*/
			font: 36px monospace;
		}
		.display-votes {
			
		}
		.drag-bar {
		}
		.grid-square {

		}

  	</style>
<!-- 	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="//d3js.org/topojson.v1.min.js"></script>
	<script src="https://d3js.org/d3-array.v1.min.js"></script>
      <script src="https://d3js.org/d3-geo.v1.min.js"></script>
      <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js" charset="utf-8"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js" charset="utf-8"></script> -->
</head>
<body>
<div id ="flipTop"></div>
<div id ="flipDisplay"></div>
<div id ="flipBars"></div>


</body>
	<script>
	


	//Visualization "global" variables
	var rColor = "#f4003d",
		dColor = "#2437ff",
		dMapColor = "#394bff",
		oColor = "#f6b500",
		initialColor = "#cccccc";

	//<button class="button">load 2016 election data</button>

	//Read in Data and create visualization from that 
	d3.tsv("data/CD_Data_all.tsv", function(data) {
		
		//nest data by CD	
		var cdData = d3.nest()
			.key(function(d) {return d.CD;}) 
			.entries(data);

		console.log(cdData);
	//
	//
	//Create global data holder.
	//Initialize to zero, fill from within makeBar()
	//////////////////////////////////////////////
		var voteDataHolder = [];
		
		for (i in cdData.length) {
			voteDataHolder.push(0);
		};

		console.log(voteDataHolder);


	//		
	//
	//Create bars for each Congressional District
	//this needs to be done first so that data values can then be read from bars
	/////////////////////////////////////////////

		var	numBars = cdData.length,
			w_bar = 25,
			h_bar = 200,
			barMargin = {top: 0, right: 11, bottom: 0, left: 11},
			boxMargin = {top: 30, right: 30, bottom: 0, left: 30};

		var barsBoxWidth = ((numBars*(barMargin.left+w_bar+barMargin.right))+(boxMargin.left+boxMargin.right)),
			barsBoxHeight = h_bar;

		//Create container to hold bars graphic
		var barsContainer = d3.select("#flipBars").append("svg")
			.attr("width", barsBoxWidth)
			.attr("height", barsBoxHeight);


		//Create dashed line to represent 50% of the votes	
		var lineLength = barsBoxWidth;

		var line = barsContainer.append("line")
			.attr("class", "bars-line")
			.attr("x1", 0)
			.attr("x2", lineLength)
			.attr("y1", 100)
			.attr("y2", h_bar/2)
			.style("stroke", "#909090")
			.style("stroke-width", "2px")
			.style("stroke-dasharray", ("2,2"))
			.style("stroke-linecap", "butt");

		//Add an SVG holder for each bar/congressional district, with the desired dimensions and margin.
		//Append a "svg: g" to each SVG that moves bar into the center of the SVG mentioned above, creating space between bars
		var svg = barsContainer.selectAll("svg")
			.data(cdData)
		  .enter()
			.append("svg") //svg container for one bar element
			.attr("width", w_bar+barMargin.left+barMargin.right)
			.attr("height", h_bar+barMargin.top+barMargin.bottom)
			.attr("x", function (d, i) {
				return (boxMargin.left+(i*(w_bar+barMargin.right+barMargin.left)));
			})
		  .append("g") //g for bar itself, placed in svg container
	    	.attr("transform", "translate(" + barMargin.left + "," + barMargin.top + ")");

    	//make tooltip
	    var barToolTip = svg.append("div")
			.attr("class", "bar-tip")



	    //Append placeholder "svg:g" for each bar that rectangles will be appended to
	    var svgbar = svg.append("g")
			.attr("width", w_bar)
			.attr("height", h_bar)
			.each(makeBar);
		
		//
		//
		//Makes one bar//////////////////////////
		function makeBar(CD) {	
			
			//Specify drag functionality
			//This must be done within makeBar as drag functionality is bar/CD specific

			//drag helper variables and functions
			var dragTimes = 0,
				startParty = 0,
				isDragging = false;
								
			//translates mouse x,y to a number of votes
			function clickToVotes(a, b) {

				var barToVotes = d3.scaleLinear()
					.domain([0, (Math.sqrt(Math.pow(h_bar, 2)+Math.pow(w_bar, 2)))])
					.range([0, cdTotalVotes])
					.clamp(true);
				
				var hyp = Math.sqrt(Math.pow(a, 2)+Math.pow(b, 2));
				return barToVotes(hyp);
			}

			//drag functions

			function initiateDrag(d) {

				//Get existing vote values on drag start/start-click
				//If this is the first drag instance, use values from read-in data file
				//Else use values that were the result of the last drag
				isDragging = true;

				if (dragTimes == 0) {
					dStartVotes = +CD.values[0].DEM_USC;
					rStartVotes = +CD.values[0].REP_USC;
					oStartVotes = +CD.values[0].OTHERS_USC;
				}
				else {
					dStartVotes = voteDataHolder[CD.key-1]["DEM"];
					rStartVotes = voteDataHolder[CD.key-1]["REP"];
					oStartVotes = voteDataHolder[CD.key-1]["OTH"];
					console.log(voteDataHolder);
				}

				var x = Math.max(0, Math.min(w_bar, d3.mouse(this)[0])),
     				y = Math.max(0, Math.min(h_bar, d3.mouse(this)[1]));

				//convert mouse position to vote number
				startVotes = clickToVotes(x, y);
				
				//determine what color/party of the bar "was clicked on"
				var getParty = function() {
					//handle cases when CD is all one party	
					//if CD is 100% one party, startParty is the other party
					//allows users to introduce other party into originally monopolized district
					if (rStartVotes == cdTotalVotes) {return "D"}
					if (dStartVotes == cdTotalVotes) {return "R"}

					//else get on click
					else if (startVotes <= rStartVotes) {return "R";}
					else if (startVotes > rStartVotes && startVotes <= (rStartVotes+oStartVotes)) {return "O";}
					else if (startVotes > (rStartVotes+oStartVotes)) {return "D";}
				};

				startParty = getParty(startVotes);
				dragTimes += 1;
			
			//end initiateDrag function ->
			}

			function dragChange(d) {
			// use this to style real-time changes, i.e. colors of squares changing
			// also display of votes
			
				//constrain displacement to dimensions of bar
				var x = Math.max(0, Math.min(w_bar, d3.mouse(this)[0])),
     				y = Math.max(0, Math.min(h_bar, d3.mouse(this)[1]));

     			//covert mouse position to vote number
				dragVotes = clickToVotes(x, y);

				//get new number of votes based on mouse position/drag 
				//and color/party that was first clicked on
				function getVotes() {
					if (startParty == "D") {
						if (dragVotes >= (cdTotalVotes-(dStartVotes+oStartVotes)) && dragVotes >= (cdTotalVotes-dStartVotes)) {
							dVotesDrag = cdTotalVotes-dragVotes;
							rVotesDrag = rStartVotes;
							oVotesDrag = cdTotalVotes-dVotesDrag-rVotesDrag;
							}
						else if (dragVotes >= (cdTotalVotes-(dStartVotes+oStartVotes)) && dragVotes < (cdTotalVotes-dStartVotes)) {
							dVotesDrag = cdTotalVotes-dragVotes;
							rVotesDrag = rStartVotes;
							oVotesDrag = cdTotalVotes-dVotesDrag-rVotesDrag;							
						}	

						else if (dragVotes < (cdTotalVotes-(dStartVotes+oStartVotes))) {
							dVotesDrag = cdTotalVotes-dragVotes;
							rVotesDrag = dragVotes;
							oVotesDrag = 0;
						}
					}
					if (startParty == "R") {
						if (dragVotes < (cdTotalVotes-(dStartVotes+oStartVotes))) {
							dVotesDrag = dStartVotes;
							rVotesDrag = dragVotes;
							oVotesDrag = cdTotalVotes-dVotesDrag-rVotesDrag;
						}
						else if (dragVotes >= (cdTotalVotes-(dStartVotes+oStartVotes)) && dragVotes < (cdTotalVotes-dStartVotes)) {
							dVotesDrag = dStartVotes;
							rVotesDrag = dragVotes;
							oVotesDrag = cdTotalVotes-dVotesDrag-rVotesDrag;;
						}
						else if (dragVotes >= (cdTotalVotes-(dStartVotes+oStartVotes)) && dragVotes >= (cdTotalVotes-dStartVotes)){
							dVotesDrag = cdTotalVotes-dragVotes;
							rVotesDrag = dragVotes;
							oVotesDrag = 0
						}
					}
					if (startParty == "O") {
						if (dragVotes < rStartVotes) {
							dVotesDrag = dStartVotes;
							rVotesDrag = dragVotes;
							oVotesDrag = cdTotalVotes-dVotesDrag-rVotesDrag;
						}
						else if (dragVotes >= rStartVotes && dragVotes < dStartVotes) {
							dVotesDrag = dStartVotes;
							rVotesDrag = rStartVotes;
							oVotesDrag = dragVotes-rStartVotes;
						}
						else if (dragVotes >= dStartVotes) {
							dVotesDrag = cdTotalVotes-dragVotes;
							rVotesDrag = rStartVotes;
							oVotesDrag = dragVotes-rStartVotes;
						}
					}
				}

				getVotes();

				dragVotesTot = (dVotesDrag+rVotesDrag+oVotesDrag);
				dPercent = (dVotesDrag/dragVotesTot);
				rPercent = (rVotesDrag/dragVotesTot);
				oPercent = (oVotesDrag/dragVotesTot);

				var cdDragVoteData = {};
				
				cdDragVoteData["CD"] = +CD.key;
				cdDragVoteData["DEM"] = +dVotesDrag
				cdDragVoteData["REP"] = +rVotesDrag;
				cdDragVoteData["OTH"] = +oVotesDrag;
			
				voteDataHolder[CD.key-1] = cdDragVoteData;

				//
				//
				/////////Update bar colors
				var perDBar = (dVotesDrag/cdTotalVotes),
					perRBar = (rVotesDrag/cdTotalVotes),
					perOBar = (oVotesDrag/cdTotalVotes),
					cutDBar = perDBar*barRows*barCols,
					cutRBar = (perDBar+perOBar)*barRows*barCols;

				
				d3.selectAll(".bar-square").filter(function(){return this.getAttribute("CD") == CD.key})
					.attr("squareColor", function() {
					if (this.getAttribute('cellnum') <= cutDBar) {
					    return dColor;
					}
					if (this.getAttribute('cellnum') > cutDBar && (this.getAttribute('cellnum') <= cutRBar)) {
						return oColor;
					}
					if (this.getAttribute('cellnum') >= cutRBar) {
					    return rColor;
					}
					else {return rColor;}
					}
					)
					.transition()
			     		.duration(60)     	
			     		.style("fill", function() {
							return this.getAttribute('squareColor')
						});

			    //
			    //
			    /////////Update grid colors
			    var dSum = 0;
				for (var key in voteDataHolder) {
					dSum += voteDataHolder[key]["DEM"];
				};

				var rSum = 0;
				for (var key in voteDataHolder) {
					rSum += voteDataHolder[key]["REP"];
				};

				var oSum = 0;
				for (var key in voteDataHolder) {
					oSum += voteDataHolder[key]["OTH"];
				};



				var paSum = (dSum+rSum+oSum),
					perDGrid = (dSum/paSum),
					perRGrid = (rSum/paSum),
					perOGrid = (oSum/paSum),
					cutDGrid = perDGrid*gridRows*gridCols,
					cutOtherGrid = ((dSum+oSum)/paSum)*gridRows*gridCols;

				d3.selectAll(".grid-square")
					.attr("squareColor", function() {
						if (this.getAttribute('cellnum') <= cutDGrid) {
					    return dColor;
						}
						if (this.getAttribute('cellnum') > cutDGrid && (this.getAttribute('cellnum') <= cutOtherGrid)) {
							return oColor;
						}
						else {return rColor;}
					})
					.transition()
				     	.duration(100)    	
				     	.style("fill", function() {
								return this.getAttribute('squareColor')
							});

				//
			    //
			    /////////Update map
			    d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") == CD.key})
			    	// .attr("class", "cd-boundaries-drag")
			    	.raise()
			    	.classed("active-drag", true)
			    	.classed("active-mouseover", false)
			    	.attr("winner", function() {
		      			if ((dVotesDrag > rVotesDrag) && (dVotesDrag > oVotesDrag)) {
		      				return "DEM";
		      			}
		      			if ((rVotesDrag > dVotesDrag) && (rVotesDrag > oVotesDrag)) {
		      				return "REP";
		      			}
		      			if ((oVotesDrag > dVotesDrag) && (oVotesDrag > rVotesDrag)) {
		      				return "OTH";
		      			}
			      	})
			      	// .style("stroke", "white")
		      		// .style("stroke-width", "2px")
		      		// .style("stroke-dasharray", "2, 4")
		      		// .style("stroke-linecap", "round")
			      	.transition()
			      		.duration(120)   	
				     	.style("fill", function(d) {
			      			if (this.getAttribute("winner") == "DEM") {
			      				return dMapColor;
			      			}
			      			if (this.getAttribute("winner") == "REP") {
			      				return rColor;
			      			}
			      			if (this.getAttribute("winner") == "OTH") {
			      				return oColor;
							}})
						;

				d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") != CD.key})
					.classed("active-drag-others", true);
				
				
				//
			    //
			    /////////Update display

			    var dSum = 0;
				var rSum = 0;
				var oSum = 0;
				for (var key in voteDataHolder) {
					dSum += voteDataHolder[key]["DEM"];
					rSum += voteDataHolder[key]["REP"];
					oSum += voteDataHolder[key]["OTH"];
				};
				
				var dDistrictSum = 0,
					rDistrictSum = 0,
					oDistrictSum = 0;
				for (var key in voteDataHolder) {
					if (voteDataHolder[key]["DEM"] >= voteDataHolder[key]["REP"] && voteDataHolder[key]["DEM"] >= voteDataHolder[key]["OTH"]) {
						dDistrictSum += 1;
					}
					if (voteDataHolder[key]["REP"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["REP"] >= voteDataHolder[key]["OTH"]) {
						rDistrictSum += 1;
					}
					if (voteDataHolder[key]["OTH"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["OTH"] >= voteDataHolder[key]["REP"]) {
						oDistrictSum += 1;
					}
				};	

				console.log(oDistrictSum);
				
				var format = d3.format(",d");

				d3.selectAll(".display-data-dem").filter(".display-votes")
					.text(format(dSum));

				d3.selectAll(".display-data-rep").filter(".display-votes")
					.text(format(rSum));

				d3.selectAll(".display-data-dem").filter(".display-districts")
					.text(format(dDistrictSum))
					;

				d3.selectAll(".display-data-rep").filter(".display-districts")
					.text(format(rDistrictSum));

				d3.selectAll(".congbar-square")
					.attr("squareColor", function() {
						if (this.getAttribute('cellnum') <= dDistrictSum) {
					    	return dColor;
						}
						if (this.getAttribute('cellnum') > dDistrictSum && (this.getAttribute('cellnum') <= (dDistrictSum+oDistrictSum))) {
							return oColor;
						}
						if (this.getAttribute('cellnum') >= (dDistrictSum+oDistrictSum)) {
					    	return rColor;
						}
						})
					.transition()
				     	.duration(100)    	
				     	.style("fill", function() {
								return this.getAttribute('squareColor')
							});

			//end dragChange function ->
			}

			function dragEnd(d) {

				isDragging = false;

				d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") == CD.key})
					.classed("active-drag", false)
					.classed("active-mouseover", false);

				d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") != CD.key})
					.classed("active-drag-others", false);

			//end dragEnd function ->
			}

			//END OF DRAG FUNCTIONAALITY////////////////////////////////

			//MOUSE FUNCTIONS///////////////////////////////////////////
			function handleMouseOver () {
		
				d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") == CD.key})
					.classed("active-mouseover", true)
					.raise();
				
				// if (isDragging == "true") {
				// 	console.log("turning off mouseover!");
				// d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") == CD.key})
				// 	.classed("active-mouseover", false);	
				// }
			}
			
			function handleMouseOut () {
				d3.selectAll(".cd-boundaries").filter(function(){return this.getAttribute("CD") == CD.key})
					.classed("active-mouseover", false);
			}
			//sets dimension of cell in bar
			var sq = 5;

			var barRows = h_bar/sq,
				barCols = w_bar/sq,
				numSquares = barRows*barCols;

			// get values from initial data
			var cdVoteData = {};
			
			cdVoteData["CD"] = +CD.key;
			cdVoteData["DEM"] = +CD.values[0].DEM_USC;
			cdVoteData["REP"] = +CD.values[0].REP_USC;
			cdVoteData["OTH"] = +CD.values[0].OTHERS_USC;
			

			voteDataHolder[CD.key-1] = cdVoteData;


			var dVotes = +voteDataHolder[CD.key-1]["DEM"],
				rVotes = +voteDataHolder[CD.key-1]["REP"],
				oVotes = +voteDataHolder[CD.key-1]["OTH"],	
				cdTotalVotes = (dVotes+rVotes+oVotes),
				perD = (dVotes/cdTotalVotes),
				perR = (rVotes/cdTotalVotes),
				perO = (oVotes/cdTotalVotes),
				cutD = perD*barRows*barCols,
				cutOther = ((dVotes+oVotes)/cdTotalVotes)*barRows*barCols;


			var delayTime = 8,
				delayTimeOther = delayTime*2
				pauseTime = 500;

			

			var svg = d3.select(this)
				.attr("class", "bar")
				.attr("CD", CD.key)
				.style("fill", "none");				

			
			//make transparent rectangle to pick up drag
			svg.append("rect")
			    .attr("class", "drag-bar")
			    .attr("CD", CD.key)
			    .style("pointer-events", "all")
			    .attr("width", w_bar)
			    .attr("height", h_bar)
			    .style("fill", "none")
			    .on("mouseover", handleMouseOver)
			    .on("mouseout", handleMouseOut)
			    .call(d3.drag()
			    	.on("start", initiateDrag)
					.on("drag", dragChange)
			    	.on("end", dragEnd));
		    	
		    
			
			//makes squares as "rect" elements
			var squares = svg.selectAll(".bar-square")
				.data(d3.range(numSquares))
		  	  .enter()
				.append('rect')
				.attr("class", "bar-square")
				.attr("CD", CD.key)
				.attr("width", sq)
				.attr("height", sq)
				.attr("cellnum", function (i) {return ((numSquares)-i);})
				.attr("x", function(i) {return (sq*(i%barCols));})
				.attr("y", function(i) {return (sq*Math.floor((i/barCols)));})
				.style("fill",initialColor)
				.style("stroke", "ffffff")
				.style("stroke-width", .4)      
    			.style("stroke-linecap", "butt")
    			.style("pointer-events", "none")		
				.attr("squareColor", function() {
					if (this.getAttribute('cellnum') <= cutD) {
					    return dColor;
					}
					if (this.getAttribute('cellnum') > cutD && (this.getAttribute('cellnum') <= cutOther)) {
						return oColor;
					}
					else {return rColor;}
				})
				.transition()
			     	.delay(function() {
						if (this.getAttribute('squareColor') == dColor) {
		   					return (pauseTime+this.getAttribute("cellnum")*delayTime);
		     			}
		     			if (this.getAttribute('squareColor') == oColor) {
		   					return (pauseTime+((this.getAttribute("cellnum")*delayTimeOther)+(cutOther*delayTime)));
		     			}
		     			if (this.getAttribute('squareColor') == rColor) {
		     	
		     				return (pauseTime+((cutD*delayTime)+((numSquares)-this.getAttribute("cellnum")+1)*delayTime));
		     				}
						})     	
			     	.style("fill", function() {
							return this.getAttribute('squareColor')
						});
			    //end makeBar function ->
			    }


	//
	//
	//Create top container (to hold map and vote grid)
	/////////////////////////////////////////////
		var topBoxWidth = 900,
			topBoxHeight = 300;

		var topContainer = d3.select("#flipTop").append("svg")
			.attr("width", topBoxWidth)
			.attr("height", topBoxHeight);

	//
	//
	//Create small map of Pennsylvania in top container
	/////////////////////////////////////////////
		var mapBoxWidth = 475,
			mapBoxHeight = 300;

		//Create container to hold map graphic
		var mapContainer = topContainer.append("svg")
			.attr("width", mapBoxWidth)
			.attr("height", mapBoxHeight)
			.attr("x", 50);


		d3.json("jsons/PA_CongDist_2015.json", function(error, pa) {
		  if (error) return console.error(error);
		  
		
			var projection = d3.geoAlbers()
		    .scale(6000)
		    .rotate( [77.1945,0] )
    		.center( [0, 41.2033] )
		    .translate([mapBoxWidth / 2, mapBoxHeight / 2]);

		    var path = d3.geoPath()
		    .projection(projection);


			mapContainer.append("g")
				.selectAll("path")
		    .data(topojson.feature(pa, pa.objects.PA_CongDist_2015).features) 
		      	.enter().append("path")
		      	.attr("class", "cd-boundaries")
		      	.attr("d", path)
		      	.attr("CD", function(d) {return +d.properties.CD114FP})
		      	.attr("winner", function(d) {
		      		var cd = this.getAttribute("CD");
		      		var dVotes = voteDataHolder[cd-1]["DEM"];
		      		var rVotes = voteDataHolder[cd-1]["REP"];
		      		var oVotes = voteDataHolder[cd-1]["OTH"];
		      		if ((dVotes > rVotes) && (dVotes > oVotes)) {
		      			return "DEM";
		      		}
		      		if ((rVotes > dVotes) && (rVotes > oVotes)) {
		      			return "REP";
		      		}
		      		if ((oVotes > dVotes) && (oVotes > rVotes)) {
		      			return "OTH";
		      		}
		      	})
		      	.style("fill", initialColor)
		      	.transition()
		      		.delay(function(d) {
		      			var cdNum = +d.properties.CD114FP;
		      			return (300+(cdNum*70));
		      		})
		      		.duration(420)   	
			     	.style("fill", function(d) {
						var cdNum = +d.properties.CD114FP;
		      			if (this.getAttribute("winner") == "DEM") {
		      				return dMapColor;
		      			}
		      			if (this.getAttribute("winner") == "REP") {
		      				return rColor;
		      			}
		      			if (this.getAttribute("winner") == "REP") {
		      				return oColor;
						}
		      		});

		      		
		//end d3.json function call ->
		});
	//end of small map 


	//
	//
	//Create vote grid for Pennsylvania at large in top container
	/////////////////////////////////////////////
		var voteGridWidth = 250,
			voteGridHeight = 250,
			gridSq = 5,
			gridRows = voteGridHeight/gridSq,
			gridCols = voteGridWidth/gridSq,
			numGridSquares = gridRows*gridCols;

		//Create container to hold vote grid graphic
		var voteGridContainer = topContainer.append("svg")
			.attr("width", voteGridWidth)
			.attr("height", voteGridHeight)
			.attr("x", 525)
			.attr("y", 50)
			.append("g");
			
			

		var grid = voteGridContainer.each(makeVoteGrid);
		


		function makeVoteGrid () {

			//var svg = voteGridContainer.append("svg");
			var svg = d3.select(this);
			
			//get vote data from voteDataHolder
			var dSum = 0;
			for (var key in voteDataHolder) {
				dSum += voteDataHolder[key]["DEM"];
			};

			var rSum = 0;
			for (var key in voteDataHolder) {
				rSum += voteDataHolder[key]["REP"];
			};

			var oSum = 0;
			for (var key in voteDataHolder) {
				oSum += voteDataHolder[key]["OTH"];
			};

			var paSum = (dSum + rSum + oSum),
				perDGrid = (dSum/paSum),
				perRGrid = (rSum/paSum),
				perOGrid = (oSum/paSum),
				cutDGrid = perDGrid*gridRows*gridCols,
				cutOtherGrid = ((dSum+oSum)/paSum)*gridRows*gridCols;

			var delayTime = 2.8,
				pauseTime = 0;

			//makes squares as "rect" elements
			var gridSquares = svg.selectAll(".grid-square")
				.data(d3.range(numGridSquares))
		  	  .enter()
				.append('rect')
				.attr("class", "grid-square")
				.attr("width", gridSq)
				.attr("height", gridSq)
				.attr("cellnum", function (i) {return ((numGridSquares)-i);})
				.attr("x", function(i) {return (gridSq*(i%gridCols));})
				.attr("y", function(i) {return (gridSq*Math.floor((i/gridCols)));})
				.style("fill",initialColor)
				.style("stroke", "ffffff")
				.style("stroke-width", .4)      
    			.style("stroke-linecap", "butt")		
				.attr("squareColor", function() {
					if (this.getAttribute('cellnum') <= cutDGrid) {
					    return dColor;
					}
					if (this.getAttribute('cellnum') > cutDGrid && (this.getAttribute('cellnum') <= cutOtherGrid)) {
						return oColor;
					}
					else {return rColor;}
				})
				.transition()
			     	.delay(function() {
						if (this.getAttribute('squareColor') == dColor) {
		   					return (pauseTime+this.getAttribute("cellnum")*delayTime);
		     			}
		     			if (this.getAttribute('squareColor') == oColor) {
		     				if (cutOtherGrid < (numGridSquares)/2) {
		   						return (pauseTime+(((numGridSquares)-(this.getAttribute("cellnum"))+1)*delayTime)+(100*delayTime));
		     				}
		     				else {
		   						return (pauseTime+((this.getAttribute("cellnum"))+1)*delayTime)+(100*delayTime);
		     				}
		     			}
		     			if (this.getAttribute('squareColor') == rColor) {
		     				return (pauseTime+((numGridSquares)-this.getAttribute("cellnum")+1)*delayTime);
		     				}
						})     	
			     	.style("fill", function() {
							return this.getAttribute('squareColor')
						});
		//end makeVoteGrid function ->
		}
	//end of vote grid

	//
	//
	//Create CD bar for Pennsylvania at large in top container
	/////////////////////////////////////////////
		var congBarWidth = (500/9),
			congBarHeight = 250,
			congBarSq = (500/18),
			congBarRows = congBarHeight/congBarSq,
			congBarCols = congBarWidth/congBarSq,
			numCongSquares = congBarRows*congBarCols;

		//Create container to hold vote grid graphic
		var congBarContainer = topContainer.append("svg")
			.attr("width", congBarWidth)
			.attr("height", congBarHeight)
			.attr("x", 860-congBarWidth)
			.attr("y", 50)
			.append("g");
			
			

		var congBar = congBarContainer.each(makecongBar);
		
		//Get data variables	
		var dSum = 0;
		var rSum = 0;
		var oSum = 0;
		for (var key in voteDataHolder) {
			dSum += voteDataHolder[key]["DEM"];
			rSum += voteDataHolder[key]["REP"];
			oSum += voteDataHolder[key]["OTH"];
		};

		var dDistrictSum = 0;
		var rDistrictSum = 0;
		var oDistrictSum = 0;
		for (var key in voteDataHolder) {
			if (voteDataHolder[key]["DEM"] >= voteDataHolder[key]["REP"] && voteDataHolder[key]["DEM"] >= voteDataHolder[key]["OTH"]) {
				dDistrictSum += 1;
			}
			if (voteDataHolder[key]["REP"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["REP"] >= voteDataHolder[key]["OTH"]) {
				rDistrictSum += 1;
			}
			if (voteDataHolder[key]["OTH"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["OTH"] >= voteDataHolder[key]["REP"]) {
				oDistrictSum += 1;
			}
		};		
		
		console.log(oDistrictSum);

		function makecongBar () {

			//var svg = voteGridContainer.append("svg");
			var svg = d3.select(this);
			
			//Get data variables	
			var dSum = 0;
			var rSum = 0;
			var oSum = 0;
			for (var key in voteDataHolder) {
				dSum += voteDataHolder[key]["DEM"];
				rSum += voteDataHolder[key]["REP"];
				oSum += voteDataHolder[key]["OTH"];
			};

			var dDistrictSum = 0;
			var rDistrictSum = 0;
			var oDistrictSum = 0;
			for (var key in voteDataHolder) {
				if (voteDataHolder[key]["DEM"] >= voteDataHolder[key]["REP"] && voteDataHolder[key]["DEM"] >= voteDataHolder[key]["OTH"]) {
					dDistrictSum += 1;
				}
				if (voteDataHolder[key]["REP"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["REP"] >= voteDataHolder[key]["OTH"]) {
					rDistrictSum += 1;
				}
				if (voteDataHolder[key]["OTH"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["OTH"] >= voteDataHolder[key]["REP"]) {
					oDistrictSum += 1;
				}
			};
			console.log(dDistrictSum);
			console.log(rDistrictSum);
			// //get vote data from voteDataHolder
			// var dSum = 0;
			// for (var key in voteDataHolder) {
			// 	dSum += voteDataHolder[key]["DEM"];
			// };

			// var rSum = 0;
			// for (var key in voteDataHolder) {
			// 	rSum += voteDataHolder[key]["REP"];
			// };

			// var oSum = 0;
			// for (var key in voteDataHolder) {
			// 	oSum += voteDataHolder[key]["OTH"];
			// };

			// var paSum = (dSum + rSum + oSum),
			// 	perDGrid = (dSum/paSum),
			// 	perRGrid = (rSum/paSum),
			// 	perOGrid = (oSum/paSum),
			// 	cutDGrid = perDGrid*gridRows*gridCols,
			// 	cutOtherGrid = ((dSum+oSum)/paSum)*gridRows*gridCols;

			var delayTime = 200,
				pauseTime = 0;

			//makes squares as "rect" elements
			var congBarSquares = svg.selectAll(".congbar-square")
				.data(d3.range(numCongSquares))
		  	  .enter()
				.append('rect')
				.attr("class", "congbar-square")
				.attr("width", congBarSq)
				.attr("height", congBarSq)
				.attr("cellnum", function (i) {return ((numCongSquares)-i);})
				.attr("x", function(i) {return (congBarSq*(i%congBarCols));})
				.attr("y", function(i) {return (congBarSq*Math.floor((i/congBarCols)));})
				.style("fill",initialColor)
				.style("stroke", "ffffff")
				.style("stroke-width", 2)      
    			.style("stroke-linecap", "butt")		
				.attr("squareColor", function() {
					if (this.getAttribute('cellnum') <= dDistrictSum) {
					    return dColor;
					}
					if (this.getAttribute('cellnum') > dDistrictSum && (this.getAttribute('cellnum') <= (dDistrictSum+oDistrictSum))) {
						return oColor;
					}
					if (this.getAttribute('cellnum') >= (dDistrictSum+oDistrictSum)) {
					    return rColor;
					}
				})
				// .style("fill", function() {
				// 			return this.getAttribute('squareColor')
				// 		})
				.transition()
			     	.delay(function() {
						if (this.getAttribute('squareColor') == dColor) {
		   					return (pauseTime+this.getAttribute("cellnum")*delayTime);
		     			}
		     			if (this.getAttribute('squareColor') == oColor) {
		     				if (cutOtherGrid < (numCongSquares)/2) {
		   						return (pauseTime+(((numCongSquares)-(this.getAttribute("cellnum"))+1)*delayTime)+(100*delayTime));
		     				}
		     				else {
		   						return (pauseTime+((this.getAttribute("cellnum"))+1)*delayTime)+(100*delayTime);
		     				}
		     			}
		     			if (this.getAttribute('squareColor') == rColor) {
		     				return (pauseTime+((numCongSquares)-this.getAttribute("cellnum")+1)*delayTime);
		     				}
						})     	
			     	.style("fill", function() {
							return this.getAttribute('squareColor')
						});
		//end makecongBar function ->
		}





	//end of top container 



	//
	//
	//Create display to show numbers
	/////////////////////////////////////////////
		var displayBoxWidth = 900,
			displayBoxHeight = 180;

		//Create container to hold vote grid graphic
		var displayContainer = d3.select("#flipDisplay").append("svg")
			.attr("width", displayBoxWidth)
			.attr("height", displayBoxHeight)
			.append("g");

		// //Get data variables	
		// var dSum = 0;
		// var rSum = 0;
		// var oSum = 0;
		// for (var key in voteDataHolder) {
		// 	dSum += voteDataHolder[key]["DEM"];
		// 	rSum += voteDataHolder[key]["REP"];
		// 	oSum += voteDataHolder[key]["OTH"];
		// };

		// var dDistrictSum = 0;
		// var rDistrictSum = 0;
		// var oDistrictSum = 0;
		// for (var key in voteDataHolder) {
		// 	if (voteDataHolder[key]["DEM"] >= voteDataHolder[key]["REP"] && voteDataHolder[key]["DEM"] >= voteDataHolder[key]["OTH"]) {
		// 		dDistrictSum += 1;
		// 	}
		// 	if (voteDataHolder[key]["REP"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["REP"] >= voteDataHolder[key]["OTH"]) {
		// 		rDistrictSum += 1;
		// 	}
		// 	if (voteDataHolder[key]["OTH"] >= voteDataHolder[key]["DEM"] && voteDataHolder[key]["OTH"] >= voteDataHolder[key]["REP"]) {
		// 		oDistrictSum += 1;
		// 	}
		// };		
	
		//Make display boxes for text elements

		//For static text
		var popBoxLabel = displayContainer.append("text")
			.attr("class", "display-label")
			.attr("x", 525)
			.attr("y", 10)
			.style("text-anchor", "left")
			.text("statewide votes: 5,757,009");

		var congDistLabel = displayContainer.append("text")
			.attr("class", "display-label")
			.attr("x", 525)
			.attr("y", 22)
			.style("text-anchor", "right")
			.text("congressional districts: 18")

		var votesFixedDisplay = displayContainer.append("text")
			.attr("class", "display-static")
			.attr("x", displayBoxWidth/2)
			.attr("y", (displayBoxHeight/2)-20+30)
			.style("text-anchor", "middle")
			.text("votes");

		var districtsFixedDisplay = displayContainer.append("text")
			.attr("class", "display-static")
			.attr("x", displayBoxWidth/2)
			.attr("y", (displayBoxHeight/2)+40+30)
			.style("text-anchor", "middle")
			.text("districts");

		
		//For dynamic text

		//Convert floating point numbers to something normal
		var format = d3.format(",d");

		//Dem Votes
		var demVotesDisplay = displayContainer.append("g")

		var demVotesNum = demVotesDisplay.append("text")
			.attr("class", "display-data-dem display-votes")
			.attr("id", "dVotesDisplay")
			.attr("width", 300)
			.attr("x", displayBoxWidth/4)
			.attr("y", (displayBoxHeight/2)-15+30)
			.style("text-anchor", "middle")
			.style("fill", dColor)
			.style("stroke", "none")
			.text("0")

		demVotesDisplay.select("text")
			.transition()
				.ease(d3.easeQuadOut) 
				.duration(2500)
				.tween("text", function() {
					var that = d3.select(this);
					var	i = interpolateNumber(that.text(), dSum);
						return function(t) { 
							that.text(format(i(t)));
						};
				});	

		//Rep Votes
		var repVotesDisplay = displayContainer.append("g")

		var repVotesNum = repVotesDisplay.append("text")
			.attr("class", "display-data-rep display-votes")
			.attr("id", "rVotesDisplay")
			.attr("width", 300)
			.attr("x", displayBoxWidth*(3/4))
			.attr("y", (displayBoxHeight/2)-15+30)
			.style("text-anchor", "middle")
			.style("fill", rColor)
			.style("stroke", "none")
			.text("0")
			

		repVotesDisplay.select("text")	
			.transition()
				.ease(d3.easeQuadOut) 
				.duration(2500)
				.tween("text", function() {
					var that = d3.select(this);
					var	i = interpolateNumber(that.text(), rSum);
						return function(t) { 
							that.text(format(i(t)));
						};
				});

		//Dem Districts
		var demDistrictsDisplay = displayContainer.append("g")

		var demDistrictsNum = demDistrictsDisplay.append("text")
			.attr("class", "display-data-dem display-districts")
			.attr("id", "dDistrictsDisplay")
			.attr("x", displayBoxWidth*(1/4))
			.attr("y", (displayBoxHeight/2)+40+30)
			.style("text-anchor", "middle")
			.style("fill", dColor)
			.text("");

		demDistrictsDisplay.select("text")	
			.transition()
				//.ease("poly-out")
				.duration(2500)
				.tween("text", function() {
					var that = d3.select(this);
					var	i = interpolateNumber(that.text(), dDistrictSum);
					return function(t) { 
						that.text(format(i(t)));
						};
				});

		
		//Rep districts
		var repDistrictsDisplay = displayContainer.append("g")

		var repDistrictsNum = repDistrictsDisplay.append("text")
			.attr("class", "display-data-rep display-districts")
			.attr("id", "rDistrictsDisplay")
			.attr("x", displayBoxWidth*(3/4))
			.attr("y", (displayBoxHeight/2)+40+30)
			.style("text-anchor", "middle")
			.style("fill", rColor)
			.text("");


		repDistrictsDisplay.select("text")	
			.transition()
				//.ease("poly-out")
				.duration(2500)
				.tween("text", function() {
					var that = d3.select(this);
					var	i = interpolateNumber(that.text(), rDistrictSum);
					return function(t) { 
						that.text(format(i(t)));
						};
				});

		function interpolateNumber(a, b) {
  			return function(t) {
    		return a + t * (b - a);
  			};
		}


	console.log(voteDataHolder);
	
	//end d3.tsv function call ->
	})	

	// 	.on("mouseover", tip.show)
	// 	.on("mouseout", tip.hide)



</script>
</body>
</html>

